<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Extend the bank statement line form view to add custom matching button -->
    <record id="view_bank_statement_line_form_custom_fields" model="ir.ui.view">
        <field name="name">account.bank.statement.line.form.custom.fields</field>
        <field name="model">account.bank.statement.line</field>
        <field name="inherit_id" ref="account_reconcile_oca.bank_statement_line_form_reconcile_view"/>
        <field name="arch" type="xml">
            <!-- Add field to track available mappings (invisible) -->
            <xpath expr="//field[@name='is_reconciled']" position="after">
                <field name="available_field_mappings_count" invisible="1"/>
            </xpath>

            <!-- Add custom buttons in the status bar -->
            <xpath expr="//div[@class='o_statusbar_buttons']/button[@name='action_show_move']" position="after">
                <button name="button_find_custom_matches"
                        string="Find Custom Matches"
                        type="object"
                        class="btn btn-success"
                        attrs="{'invisible': ['|', ('available_field_mappings_count', '=', 0), ('is_reconciled', '=', True)]}"/>
                <button name="action_show_custom_field_mappings"
                        string="Configure Mappings"
                        type="object"
                        class="btn btn-secondary"
                        icon="fa-cog"
                        attrs="{'invisible': [('is_reconciled', '=', True)]}"/>
            </xpath>

            <!-- Add information banner when mappings are available -->
            <xpath expr="//field[@name='reconcile_data_info']" position="before">
                <div class="alert alert-info mb-2" role="alert"
                     attrs="{'invisible': ['|', ('available_field_mappings_count', '=', 0), ('is_reconciled', '=', True)]}">
                    <i class="fa fa-info-circle mr-2"/>
                    <strong><field name="available_field_mappings_count" class="oe_inline"/> custom field mapping(s) available.</strong>
                    Click "Find Custom Matches" to search for matching invoices automatically.
                </div>
            </xpath>
        </field>
    </record>
</odoo>
