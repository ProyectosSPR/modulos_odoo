<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Extend the reconcile form view to add custom field filters -->
    <record id="account_account_reconcile_form_custom_view" model="ir.ui.view">
        <field name="name">account.account.reconcile.form.custom</field>
        <field name="model">account.account.reconcile</field>
        <field name="inherit_id" ref="account_reconcile_oca.account_account_reconcile_form_view"/>
        <field name="arch" type="xml">
            <!-- Add custom filter fields (hidden) -->
            <xpath expr="//field[@name='is_reconciled']" position="after">
                <field name="custom_field_mapping_id" invisible="1"/>
                <field name="custom_filter_value" invisible="1"/>
                <field name="flexible_mode" invisible="1"/>
                <field name="tolerance_amount" invisible="1"/>
                <field name="adjustment_account_id" invisible="1"/>
                <field name="processed_groups" invisible="1"/>
                <field name="company_currency_id" invisible="1"/>
            </xpath>

            <!-- Add custom filter buttons -->
            <xpath expr="//div[@class='o_statusbar_buttons']/button[@name='clean_reconcile']" position="after">
                <button name="find_next_match"
                        string="Buscar Siguiente Coincidencia"
                        type="object"
                        class="btn btn-success"
                        attrs="{'invisible': ['|', ('is_reconciled', '=', True), ('custom_field_mapping_id', '=', False)]}"/>
                <button name="reconcile_all_remaining_matches"
                        string="Aplicar Todos los Restantes"
                        type="object"
                        class="btn btn-primary"
                        attrs="{'invisible': ['|', ('is_reconciled', '=', True), ('custom_field_mapping_id', '=', False)]}"/>
                <button name="button_reset_session"
                        string="Reiniciar Sesión"
                        type="object"
                        class="btn btn-warning"
                        attrs="{'invisible': ['|', ('is_reconciled', '=', True), ('custom_field_mapping_id', '=', False)]}"/>
                <button name="button_clear_custom_filter"
                        string="Limpiar"
                        type="object"
                        class="btn btn-secondary"
                        attrs="{'invisible': [('is_reconciled', '=', True)]}"/>
            </xpath>

            <!-- Add custom filter fields in the form -->
            <xpath expr="//group" position="after">
                <div class="alert alert-info" role="alert"
                     attrs="{'invisible': [('is_reconciled', '=', True)]}">
                    <h4><i class="fa fa-magic"/> Conciliación Masiva Asistida</h4>
                    <p><strong>Modo de Operación:</strong></p>
                    <ul>
                        <li><strong>Buscar Siguiente:</strong> Presenta el siguiente grupo balanceado para conciliar</li>
                        <li><strong>Aplicar Todos:</strong> Concilia automáticamente todos los grupos restantes dentro del margen de error</li>
                    </ul>
                </div>

                <group string="1. Configuración del Mapeo" name="custom_filters"
                       attrs="{'invisible': [('is_reconciled', '=', True)]}">
                    <field name="custom_field_mapping_id"
                           placeholder="Seleccione un mapeo de campos..."
                           options="{'no_create': True, 'no_open': True}"
                           required="0"/>
                </group>

                <group string="2. Configuración de Tolerancia" name="tolerance_config"
                       attrs="{'invisible': ['|', ('is_reconciled', '=', True), ('custom_field_mapping_id', '=', False)]}"
                       col="2">
                    <group>
                        <field name="flexible_mode" widget="boolean_toggle"/>
                        <field name="tolerance_amount"
                               attrs="{'invisible': [('flexible_mode', '=', True)], 'required': [('flexible_mode', '=', False)]}"
                               widget="monetary"/>
                    </group>
                    <group>
                        <field name="adjustment_account_id"
                               domain="[('company_id', '=', company_id), ('reconcile', '=', True)]"
                               options="{'no_create': True}"
                               attrs="{'required': [('flexible_mode', '=', False), ('tolerance_amount', '>', 0)]}"/>
                    </group>
                </group>

                <div class="alert alert-warning" role="alert"
                     attrs="{'invisible': ['|', '|', ('is_reconciled', '=', True), ('custom_field_mapping_id', '=', False), ('flexible_mode', '=', False)]}">
                    <p><i class="fa fa-warning"/> <strong>Modo Flexible Activado:</strong> Se mostrarán todos los grupos sin importar su balance. Deberás resolverlos manualmente.</p>
                </div>

                <div class="alert alert-success" role="alert"
                     attrs="{'invisible': ['|', '|', ('is_reconciled', '=', True), ('custom_field_mapping_id', '=', False), ('flexible_mode', '=', True)]}">
                    <p><i class="fa fa-check"/> <strong>Modo Preciso:</strong> Solo se mostrarán grupos con diferencia ≤ <field name="tolerance_amount" readonly="1" class="oe_inline"/>. Se crearán ajustes automáticos si es necesario.</p>
                </div>
            </xpath>
        </field>
    </record>

    <!-- Extend the search view to add custom filters -->
    <record id="account_account_reconcile_search_custom_view" model="ir.ui.view">
        <field name="name">account.account.reconcile.search.custom</field>
        <field name="model">account.account.reconcile</field>
        <field name="inherit_id" ref="account_reconcile_oca.account_account_reconcile_search_view"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <separator/>
                <filter string="With Custom Mappings" name="with_custom_mappings"
                        domain="[]"
                        help="Show only accounts with available custom field mappings"/>
                <group expand="0" string="Group By">
                    <filter string="Account" name="group_account"
                            context="{'group_by': 'account_id'}"/>
                    <filter string="Partner" name="group_partner"
                            context="{'group_by': 'partner_id'}"/>
                </group>
            </xpath>
        </field>
    </record>

    <!-- Custom Kanban view for reconciliation with custom fields -->
    <record id="account_account_reconcile_custom_kanban_view" model="ir.ui.view">
        <field name="name">account.account.reconcile.custom.kanban</field>
        <field name="model">account.account.reconcile.custom</field>
        <field name="arch" type="xml">
            <kanban js_class="reconcile" create="false" delete="false">
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_card oe_kanban_global_click" style="width:100%">
                            <div class="o_kanban_card_header">
                                <div class="o_kanban_card_header_title">
                                    <div class="o_primary">
                                        <i class="fa fa-building-o mr-2"/>
                                        <strong><field name="account_id"/></strong>
                                    </div>
                                </div>
                            </div>
                            <div class="container o_kanban_card_content mt-2">
                                <div class="row">
                                    <div class="col-12">
                                        <i class="fa fa-user mr-2"/>
                                        <field name="partner_id"/>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <span class="badge badge-info">
                                            <i class="fa fa-filter"/>
                                            Click to apply custom filters
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Custom Form view -->
    <record id="account_account_reconcile_custom_form_view" model="ir.ui.view">
        <field name="name">account.account.reconcile.custom.form</field>
        <field name="model">account.account.reconcile.custom</field>
        <field name="inherit_id" ref="account_reconcile_custom_fields.account_account_reconcile_form_custom_view"/>
        <field name="mode">primary</field>
        <field name="arch" type="xml">
            <xpath expr="//form" position="attributes">
                <attribute name="string">Reconcile with Custom Fields</attribute>
            </xpath>
        </field>
    </record>

    <!-- Action for custom field reconciliation -->
    <record id="account_account_reconcile_custom_action" model="ir.actions.act_window">
        <field name="name">Reconcile with Custom Fields</field>
        <field name="res_model">account.account.reconcile.custom</field>
        <field name="view_mode">kanban,form</field>
        <field name="domain">[]</field>
        <field name="context">{
            'view_ref': 'account_reconcile_custom_fields.account_account_reconcile_custom_form_view'
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Start reconciling with custom field filters
            </p>
            <p>
                Select an account and partner combination to reconcile,
                then use custom field mappings to automatically find matching invoices
                based on sale orders, purchase orders, or custom fields.
            </p>
        </field>
    </record>

    <!-- Menu item -->
    <menuitem
        id="menu_account_reconcile_custom"
        name="Reconcile with Custom Fields"
        parent="account.menu_finance_entries_actions"
        action="account_account_reconcile_custom_action"
        sequence="11"/>
</odoo>
