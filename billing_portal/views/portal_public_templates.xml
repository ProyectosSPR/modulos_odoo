<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!--
        Templates PÚBLICOS del Portal de Facturación
        No requieren autenticación
    -->

    <!-- Página principal de búsqueda -->
    <template id="portal_search" name="Portal Search">
        <t t-call="website.layout">
            <div id="wrap" class="billing-portal-wrap">
                <div class="container py-5">
                    <div class="row justify-content-center">
                        <div class="col-lg-10">
                            <!-- Header -->
                            <div class="text-center mb-5">
                                <i class="fa fa-file-invoice-dollar fa-4x text-primary mb-3"></i>
                                <h1>Portal de Facturación</h1>
                                <p class="lead text-muted">Busque sus pedidos para solicitar factura</p>
                            </div>

                            <div class="row">
                                <!-- Columna izquierda: Búsqueda y resultados -->
                                <div class="col-lg-7">
                                    <!-- Formulario de búsqueda -->
                                    <div class="card shadow mb-4">
                                        <div class="card-body p-4">
                                            <form method="post" action="/portal/billing" id="searchForm">
                                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                                <input type="hidden" name="selected_orders" id="selectedOrdersInput"
                                                       t-att-value="','.join([str(o.id) for o in selected_orders]) if selected_orders else ''"/>

                                                <div class="mb-3">
                                                    <label for="order_ref" class="form-label fw-bold">
                                                        <i class="fa fa-search me-2"></i>
                                                        Número de Pedido o Referencia
                                                    </label>
                                                    <div class="input-group">
                                                        <input type="text"
                                                               class="form-control form-control-lg"
                                                               id="order_ref"
                                                               name="order_ref"
                                                               t-att-value="order_ref or ''"
                                                               placeholder="Ej: SO001 o 2000014377529150"
                                                               required="required"
                                                               minlength="2"/>
                                                        <button type="submit" class="btn btn-primary btn-lg">
                                                            <i class="fa fa-search"></i>
                                                        </button>
                                                    </div>
                                                    <small class="text-muted">
                                                        Busque y agregue varias órdenes para facturarlas juntas
                                                    </small>
                                                </div>
                                            </form>
                                        </div>
                                    </div>

                                    <!-- Error -->
                                    <t t-if="error">
                                        <div class="alert alert-warning">
                                            <i class="fa fa-exclamation-triangle me-2"></i>
                                            <t t-esc="error"/>
                                        </div>
                                    </t>

                                    <!-- Resultados de búsqueda -->
                                    <t t-if="orders">
                                        <div class="card border-success mb-4">
                                            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0">
                                                    <i class="fa fa-check-circle me-2"></i>
                                                    <t t-esc="len(orders)"/> Pedido(s) Encontrado(s)
                                                </h5>
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="table-responsive">
                                                    <table class="table table-hover mb-0">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th style="width: 50px;"></th>
                                                                <th>Pedido</th>
                                                                <th>Referencia</th>
                                                                <th>Total</th>
                                                                <th>Estado</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <t t-foreach="orders" t-as="order">
                                                                <tr t-att-class="'table-secondary' if not order.is_portal_billable else ''">
                                                                    <td class="text-center">
                                                                        <t t-if="order.is_portal_billable">
                                                                            <button type="button"
                                                                                    class="btn btn-sm btn-outline-success add-order-btn"
                                                                                    t-att-data-order-id="order.id"
                                                                                    t-att-data-order-name="order.name"
                                                                                    t-att-data-order-ref="order.client_order_ref or ''"
                                                                                    t-att-data-order-total="order.amount_total"
                                                                                    title="Agregar a facturación">
                                                                                <i class="fa fa-plus"></i>
                                                                            </button>
                                                                        </t>
                                                                        <t t-else="">
                                                                            <i class="fa fa-ban text-muted" title="No facturable"></i>
                                                                        </t>
                                                                    </td>
                                                                    <td>
                                                                        <strong t-esc="order.name"/>
                                                                        <br/>
                                                                        <small class="text-muted" t-esc="order.date_order" t-options="{'widget': 'date'}"/>
                                                                    </td>
                                                                    <td>
                                                                        <t t-esc="order.client_order_ref or '-'"/>
                                                                    </td>
                                                                    <td>
                                                                        <t t-esc="order.amount_total" t-options="{'widget': 'monetary', 'display_currency': order.currency_id}"/>
                                                                    </td>
                                                                    <td>
                                                                        <span t-if="order.is_portal_billable" class="badge bg-success">
                                                                            Facturable
                                                                        </span>
                                                                        <span t-elif="order.invoice_status == 'invoiced'" class="badge bg-info">
                                                                            Ya facturado
                                                                        </span>
                                                                        <span t-else="" class="badge bg-secondary">
                                                                            No facturable
                                                                        </span>
                                                                    </td>
                                                                </tr>
                                                            </t>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </t>

                                    <!-- Requisitos -->
                                    <div class="card border-info">
                                        <div class="card-header bg-info text-white">
                                            <i class="fa fa-info-circle me-2"></i>
                                            Requisitos para facturar
                                        </div>
                                        <div class="card-body">
                                            <ul class="mb-0">
                                                <li>El pedido debe estar <strong>entregado</strong></li>
                                                <li>Debe tener su <strong>Constancia de Situación Fiscal (CSF)</strong> del SAT</li>
                                                <li>Debe <strong>iniciar sesión o crear una cuenta</strong> para solicitar factura</li>
                                                <li>Puede <strong>agregar varias órdenes</strong> para facturarlas juntas</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Columna derecha: Carrito de facturación -->
                                <div class="col-lg-5">
                                    <div class="card shadow-lg border-primary sticky-top" style="top: 20px;" id="billingCart">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="mb-0">
                                                <i class="fa fa-shopping-cart me-2"></i>
                                                Órdenes a Facturar
                                                <span class="badge bg-light text-primary ms-2" id="cartCount">
                                                    <t t-esc="len(selected_orders) if selected_orders else 0"/>
                                                </span>
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <!-- Lista de órdenes seleccionadas -->
                                            <div id="selectedOrdersList">
                                                <t t-if="selected_orders">
                                                    <t t-foreach="selected_orders" t-as="sel_order">
                                                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded selected-order-item"
                                                             t-att-data-order-id="sel_order.id">
                                                            <div>
                                                                <strong t-esc="sel_order.name"/>
                                                                <t t-if="sel_order.client_order_ref">
                                                                    <br/><small class="text-muted" t-esc="sel_order.client_order_ref"/>
                                                                </t>
                                                            </div>
                                                            <div class="d-flex align-items-center">
                                                                <span class="me-2" t-esc="sel_order.amount_total" t-options="{'widget': 'monetary', 'display_currency': sel_order.currency_id}"/>
                                                                <button type="button" class="btn btn-sm btn-outline-danger remove-order-btn"
                                                                        t-att-data-order-id="sel_order.id">
                                                                    <i class="fa fa-times"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </t>
                                                </t>
                                                <div id="emptyCartMessage" t-att-class="'text-center text-muted py-4' if not selected_orders else 'd-none text-center text-muted py-4'">
                                                    <i class="fa fa-inbox fa-3x mb-3"></i>
                                                    <p>No hay órdenes seleccionadas</p>
                                                    <small>Busque y agregue órdenes usando el botón <i class="fa fa-plus text-success"></i></small>
                                                </div>
                                            </div>

                                            <!-- Total -->
                                            <hr/>
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <strong>Total a facturar:</strong>
                                                <strong class="text-primary fs-5" id="cartTotal">
                                                    $<t t-esc="sum(o.amount_total for o in selected_orders) if selected_orders else 0" t-options="{'widget': 'float', 'precision': 2}"/>
                                                </strong>
                                            </div>

                                            <!-- Botón de facturar -->
                                            <div class="d-grid gap-2">
                                                <t t-if="is_logged_in">
                                                    <button type="button" class="btn btn-success btn-lg" id="btnFacturar"
                                                            t-att-disabled="'disabled' if not selected_orders else None">
                                                        <i class="fa fa-file-invoice me-2"></i>
                                                        Solicitar Factura
                                                    </button>
                                                </t>
                                                <t t-else="">
                                                    <a href="/web/login?redirect=/portal/billing" class="btn btn-primary btn-lg">
                                                        <i class="fa fa-sign-in-alt me-2"></i>
                                                        Iniciar Sesión para Facturar
                                                    </a>
                                                    <a href="/web/signup" class="btn btn-outline-primary">
                                                        <i class="fa fa-user-plus me-2"></i>
                                                        Crear Cuenta
                                                    </a>
                                                </t>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Información para usuarios logueados -->
                                    <t t-if="is_logged_in">
                                        <div class="card mt-3">
                                            <div class="card-body">
                                                <h6><i class="fa fa-user me-2"></i>Sesión Activa</h6>
                                                <p class="mb-2 small">Conectado como: <strong t-esc="request.env.user.name"/></p>
                                                <div class="d-flex gap-2">
                                                    <a href="/my/billing/orders" class="btn btn-outline-primary btn-sm">
                                                        <i class="fa fa-list me-1"></i>
                                                        Mis Órdenes
                                                    </a>
                                                    <a href="/my/billing/requests" class="btn btn-outline-secondary btn-sm">
                                                        <i class="fa fa-history me-1"></i>
                                                        Historial
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- JavaScript para manejo del carrito -->
            <script type="text/javascript">
                document.addEventListener('DOMContentLoaded', function() {
                    var selectedOrders = {};
                    var currencySymbol = '$';

                    // Inicializar con órdenes ya seleccionadas
                    document.querySelectorAll('.selected-order-item').forEach(function(item) {
                        var orderId = item.dataset.orderId;
                        var totalText = item.querySelector('.me-2').textContent;
                        var total = parseFloat(totalText.replace(/[^0-9.-]+/g, '')) || 0;
                        selectedOrders[orderId] = {
                            id: orderId,
                            name: item.querySelector('strong').textContent,
                            ref: item.querySelector('small') ? item.querySelector('small').textContent : '',
                            total: total
                        };
                    });

                    // Agregar orden al carrito
                    document.querySelectorAll('.add-order-btn').forEach(function(btn) {
                        btn.addEventListener('click', function() {
                            var orderId = this.dataset.orderId;
                            if (selectedOrders[orderId]) {
                                alert('Esta orden ya está en el carrito');
                                return;
                            }

                            var orderData = {
                                id: orderId,
                                name: this.dataset.orderName,
                                ref: this.dataset.orderRef,
                                total: parseFloat(this.dataset.orderTotal) || 0
                            };

                            selectedOrders[orderId] = orderData;
                            addOrderToCart(orderData);
                            updateCart();

                            // Cambiar botón a check
                            this.classList.remove('btn-outline-success');
                            this.classList.add('btn-success');
                            this.innerHTML = '<i class="fa fa-check"></i>';
                            this.disabled = true;
                        });
                    });

                    // Función para agregar orden visualmente al carrito
                    function addOrderToCart(order) {
                        var list = document.getElementById('selectedOrdersList');
                        var emptyMsg = document.getElementById('emptyCartMessage');
                        emptyMsg.classList.add('d-none');

                        // Crear elemento div en lugar de usar innerHTML
                        var div = document.createElement('div');
                        div.className = 'd-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded selected-order-item';
                        div.setAttribute('data-order-id', order.id);

                        var infoDiv = document.createElement('div');
                        var strong = document.createElement('strong');
                        strong.textContent = order.name;
                        infoDiv.appendChild(strong);

                        if (order.ref) {
                            infoDiv.appendChild(document.createElement('br'));
                            var small = document.createElement('small');
                            small.className = 'text-muted';
                            small.textContent = order.ref;
                            infoDiv.appendChild(small);
                        }

                        var actionsDiv = document.createElement('div');
                        actionsDiv.className = 'd-flex align-items-center';

                        var priceSpan = document.createElement('span');
                        priceSpan.className = 'me-2';
                        priceSpan.textContent = currencySymbol + order.total.toFixed(2);
                        actionsDiv.appendChild(priceSpan);

                        var removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.className = 'btn btn-sm btn-outline-danger remove-order-btn';
                        removeBtn.setAttribute('data-order-id', order.id);
                        removeBtn.innerHTML = '<i class="fa fa-times"></i>';
                        removeBtn.addEventListener('click', function() {
                            removeOrder(order.id);
                        });
                        actionsDiv.appendChild(removeBtn);

                        div.appendChild(infoDiv);
                        div.appendChild(actionsDiv);

                        // Insertar antes del mensaje vacío
                        list.insertBefore(div, emptyMsg);
                    }

                    // Eliminar orden del carrito
                    function removeOrder(orderId) {
                        delete selectedOrders[orderId];

                        var item = document.querySelector('.selected-order-item[data-order-id="' + orderId + '"]');
                        if (item) item.remove();

                        // Restaurar botón de agregar si está visible
                        var addBtn = document.querySelector('.add-order-btn[data-order-id="' + orderId + '"]');
                        if (addBtn) {
                            addBtn.classList.remove('btn-success');
                            addBtn.classList.add('btn-outline-success');
                            addBtn.innerHTML = '<i class="fa fa-plus"></i>';
                            addBtn.disabled = false;
                        }

                        updateCart();
                    }

                    // Eventos para botones de eliminar existentes
                    document.querySelectorAll('.remove-order-btn').forEach(function(btn) {
                        btn.addEventListener('click', function() {
                            removeOrder(this.dataset.orderId);
                        });
                    });

                    // Actualizar contador y total
                    function updateCart() {
                        var count = Object.keys(selectedOrders).length;
                        var total = 0;

                        for (var id in selectedOrders) {
                            total += selectedOrders[id].total;
                        }

                        document.getElementById('cartCount').textContent = count;
                        document.getElementById('cartTotal').textContent = currencySymbol + total.toFixed(2);

                        // Actualizar input hidden
                        var ids = Object.keys(selectedOrders).join(',');
                        document.getElementById('selectedOrdersInput').value = ids;

                        // Habilitar/deshabilitar botón de facturar
                        var btnFacturar = document.getElementById('btnFacturar');
                        if (btnFacturar) {
                            btnFacturar.disabled = count === 0;
                        }

                        // Mostrar/ocultar mensaje vacío
                        var emptyMsg = document.getElementById('emptyCartMessage');
                        if (count === 0) {
                            emptyMsg.classList.remove('d-none');
                        } else {
                            emptyMsg.classList.add('d-none');
                        }
                    }

                    // Botón facturar - redirigir con IDs
                    var btnFacturar = document.getElementById('btnFacturar');
                    if (btnFacturar) {
                        btnFacturar.addEventListener('click', function() {
                            var ids = Object.keys(selectedOrders).join(',');
                            if (ids) {
                                window.location.href = '/portal/billing/request?order_ids=' + ids;
                            }
                        });
                    }

                    // Marcar botones de órdenes ya seleccionadas como agregadas
                    for (var id in selectedOrders) {
                        var addBtn = document.querySelector('.add-order-btn[data-order-id="' + id + '"]');
                        if (addBtn) {
                            addBtn.classList.remove('btn-outline-success');
                            addBtn.classList.add('btn-success');
                            addBtn.innerHTML = '<i class="fa fa-check"></i>';
                            addBtn.disabled = true;
                        }
                    }
                });
            </script>
        </t>
    </template>

    <!-- Ver detalles de orden (público) -->
    <template id="portal_order_view" name="Portal Order View">
        <t t-call="website.layout">
            <div id="wrap" class="billing-portal-wrap">
                <div class="container py-5">
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="card shadow">
                                <div class="card-header bg-primary text-white">
                                    <h4 class="mb-0">
                                        <i class="fa fa-shopping-cart me-2"></i>
                                        Orden: <t t-esc="order.name"/>
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <h6 class="text-muted">Información del Pedido</h6>
                                            <p><strong>Número:</strong> <t t-esc="order.name"/></p>
                                            <p t-if="order.client_order_ref">
                                                <strong>Referencia:</strong> <t t-esc="order.client_order_ref"/>
                                            </p>
                                            <p><strong>Fecha:</strong>
                                                <t t-esc="order.date_order" t-options="{'widget': 'date'}"/>
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-muted">Totales</h6>
                                            <p><strong>Total:</strong>
                                                <t t-esc="order.amount_total" t-options="{'widget': 'monetary', 'display_currency': order.currency_id}"/>
                                            </p>
                                            <p><strong>Estado facturación:</strong>
                                                <t t-if="order.invoice_status == 'invoiced'">
                                                    <span class="badge bg-success">Facturado</span>
                                                </t>
                                                <t t-elif="order.invoice_status == 'to invoice'">
                                                    <span class="badge bg-warning">Pendiente</span>
                                                </t>
                                                <t t-else="">
                                                    <span class="badge bg-secondary"><t t-esc="order.invoice_status"/></span>
                                                </t>
                                            </p>
                                        </div>
                                    </div>

                                    <hr/>

                                    <t t-if="is_billable">
                                        <t t-if="is_logged_in">
                                            <div class="d-grid">
                                                <a t-attf-href="/portal/billing/request/#{order.id}"
                                                   class="btn btn-success btn-lg">
                                                    <i class="fa fa-file-invoice me-2"></i>
                                                    Solicitar Factura
                                                </a>
                                            </div>
                                        </t>
                                        <t t-else="">
                                            <div class="alert alert-info">
                                                <i class="fa fa-info-circle me-2"></i>
                                                Para solicitar factura debe iniciar sesión o crear una cuenta.
                                            </div>
                                            <div class="d-grid gap-2 d-md-flex">
                                                <a t-attf-href="/web/login?redirect=/portal/billing/request/#{order.id}"
                                                   class="btn btn-primary btn-lg flex-fill">
                                                    <i class="fa fa-sign-in-alt me-2"></i>
                                                    Iniciar Sesión
                                                </a>
                                                <a href="/web/signup" class="btn btn-outline-primary btn-lg flex-fill">
                                                    <i class="fa fa-user-plus me-2"></i>
                                                    Crear Cuenta
                                                </a>
                                            </div>
                                        </t>
                                    </t>
                                    <t t-else="">
                                        <div class="alert alert-warning">
                                            <i class="fa fa-exclamation-triangle me-2"></i>
                                            <strong>Esta orden no puede facturarse:</strong>
                                            <t t-esc="not_billable_reason"/>
                                        </div>
                                    </t>

                                    <div class="mt-4">
                                        <a href="/portal/billing" class="btn btn-outline-secondary">
                                            <i class="fa fa-arrow-left me-2"></i>
                                            Volver a Búsqueda
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Mis órdenes (requiere login) -->
    <template id="portal_my_orders" name="Portal My Orders">
        <t t-call="website.layout">
            <div id="wrap" class="billing-portal-wrap">
                <div class="container py-5">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2>
                                    <i class="fa fa-shopping-cart me-2"></i>
                                    Mis Órdenes
                                </h2>
                                <div>
                                    <a href="/portal/billing/history" class="btn btn-outline-secondary">
                                        <i class="fa fa-history me-2"></i>
                                        Historial de Solicitudes
                                    </a>
                                </div>
                            </div>

                            <!-- Búsqueda -->
                            <div class="card mb-4">
                                <div class="card-body">
                                    <form method="get" action="/portal/billing/orders">
                                        <div class="input-group">
                                            <input type="text"
                                                   name="search"
                                                   class="form-control"
                                                   placeholder="Buscar por número o referencia..."
                                                   t-att-value="search or ''"/>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fa fa-search"></i>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Lista de órdenes -->
                            <t t-if="orders">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Número</th>
                                                <th>Referencia</th>
                                                <th>Fecha</th>
                                                <th>Total</th>
                                                <th>Estado</th>
                                                <th>Acción</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="orders" t-as="order">
                                                <tr>
                                                    <td><t t-esc="order.name"/></td>
                                                    <td><t t-esc="order.client_order_ref or '-'"/></td>
                                                    <td><t t-esc="order.date_order" t-options="{'widget': 'date'}"/></td>
                                                    <td><t t-esc="order.amount_total" t-options="{'widget': 'monetary', 'display_currency': order.currency_id}"/></td>
                                                    <td>
                                                        <t t-if="order.is_portal_billable">
                                                            <span class="badge bg-success">Facturable</span>
                                                        </t>
                                                        <t t-elif="order.invoice_status == 'invoiced'">
                                                            <span class="badge bg-info">Facturado</span>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="badge bg-secondary">No facturable</span>
                                                        </t>
                                                    </td>
                                                    <td>
                                                        <t t-if="order.is_portal_billable">
                                                            <a t-attf-href="/portal/billing/request/#{order.id}"
                                                               class="btn btn-sm btn-success">
                                                                <i class="fa fa-file-invoice"></i>
                                                                Facturar
                                                            </a>
                                                        </t>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </t>
                            <t t-else="">
                                <div class="alert alert-info">
                                    <i class="fa fa-info-circle me-2"></i>
                                    No se encontraron órdenes.
                                </div>
                            </t>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo>
