<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Página de progreso -->
    <template id="portal_progress" name="Portal Progress">
        <t t-call="billing_portal.portal_layout">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fa fa-tasks me-2"></i>
                                    Estado de Solicitud
                                </h5>
                                <span class="badge bg-secondary">
                                    <t t-esc="billing_request.name"/>
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Barra de progreso -->
                            <div class="progress-section mb-4">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Progreso</span>
                                    <strong><span id="progressPercent"><t t-esc="billing_request.progress"/></span>%</strong>
                                </div>
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                                         id="progressBar"
                                         role="progressbar"
                                         t-attf-style="width: #{billing_request.progress}%"
                                         t-att-aria-valuenow="billing_request.progress"
                                         aria-valuemin="0"
                                         aria-valuemax="100">
                                    </div>
                                </div>
                            </div>

                            <!-- Estado actual -->
                            <div class="status-message mb-4 p-3 rounded"
                                 id="statusMessage"
                                 t-att-class="'alert alert-danger' if billing_request.state == 'error' else ('alert alert-success' if billing_request.state == 'done' else ('alert alert-warning' if billing_request.state == 'pending_stamp' else 'alert alert-info'))">
                                <div class="d-flex align-items-center">
                                    <t t-if="billing_request.state == 'error'">
                                        <i class="fa fa-exclamation-circle fa-2x me-3"></i>
                                    </t>
                                    <t t-elif="billing_request.state == 'done'">
                                        <i class="fa fa-check-circle fa-2x me-3"></i>
                                    </t>
                                    <t t-elif="billing_request.state == 'pending_stamp'">
                                        <i class="fa fa-clock-o fa-2x me-3"></i>
                                    </t>
                                    <t t-else="">
                                        <div class="spinner-border me-3" role="status"></div>
                                    </t>
                                    <div>
                                        <strong id="statusTitle">
                                            <t t-if="billing_request.state == 'draft'">Iniciando...</t>
                                            <t t-elif="billing_request.state == 'validating'">Validando CSF...</t>
                                            <t t-elif="billing_request.state == 'csf_validated'">CSF Validado</t>
                                            <t t-elif="billing_request.state == 'creating_partner'">Creando Cliente...</t>
                                            <t t-elif="billing_request.state == 'creating_invoice'">Creando Factura...</t>
                                            <t t-elif="billing_request.state == 'pending_stamp'">En Revision por Contabilidad</t>
                                            <t t-elif="billing_request.state == 'done'">Factura Timbrada y Enviada</t>
                                            <t t-elif="billing_request.state == 'error'">Error en el Proceso</t>
                                            <t t-else=""><t t-esc="billing_request.state"/></t>
                                        </strong>
                                        <p class="mb-0" id="statusDetail">
                                            <t t-if="billing_request.state == 'pending_stamp'">
                                                Su solicitud fue procesada exitosamente. El area de contabilidad revisara y timbrara su factura.
                                            </t>
                                            <t t-else="">
                                                <t t-esc="billing_request.status_message or billing_request.error_message or ''"/>
                                            </t>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Panel informativo para pending_stamp -->
                            <t t-if="billing_request.state == 'pending_stamp'">
                                <div class="alert alert-light border mb-4">
                                    <h6 class="alert-heading">
                                        <i class="fa fa-info-circle text-primary me-2"></i>
                                        ¿Que sigue ahora?
                                    </h6>
                                    <ol class="mb-0 ps-3">
                                        <li class="mb-2">El area de contabilidad revisara su factura</li>
                                        <li class="mb-2">Una vez aprobada, se realizara el timbrado fiscal (CFDI)</li>
                                        <li class="mb-2">Recibira su factura timbrada en: <strong><t t-esc="billing_request.email"/></strong></li>
                                    </ol>
                                    <hr/>
                                    <p class="mb-0 small text-muted">
                                        <i class="fa fa-comments me-1"></i>
                                        Si tiene alguna duda o necesita hacer cambios, puede comunicarse con contabilidad usando el chat de abajo.
                                    </p>
                                </div>
                            </t>

                            <!-- Pasos del proceso -->
                            <div class="process-steps">
                                <h6 class="mb-3">Proceso de Facturación</h6>
                                <ul class="list-group">
                                    <li class="list-group-item d-flex align-items-center"
                                        t-att-class="'list-group-item-success' if billing_request.progress >= 10 else ''">
                                        <t t-if="billing_request.progress >= 10">
                                            <i class="fa fa-check-circle text-success me-3"></i>
                                        </t>
                                        <t t-elif="billing_request.state == 'validating'">
                                            <div class="spinner-border spinner-border-sm text-primary me-3"></div>
                                        </t>
                                        <t t-else="">
                                            <i class="fa fa-circle text-muted me-3"></i>
                                        </t>
                                        <span>Validación de CSF</span>
                                    </li>
                                    <li class="list-group-item d-flex align-items-center"
                                        t-att-class="'list-group-item-success' if billing_request.progress >= 40 else ''">
                                        <t t-if="billing_request.progress >= 40">
                                            <i class="fa fa-check-circle text-success me-3"></i>
                                        </t>
                                        <t t-elif="billing_request.state == 'creating_partner'">
                                            <div class="spinner-border spinner-border-sm text-primary me-3"></div>
                                        </t>
                                        <t t-else="">
                                            <i class="fa fa-circle text-muted me-3"></i>
                                        </t>
                                        <span>Registro de Cliente</span>
                                        <t t-if="billing_request.partner_created">
                                            <span class="badge bg-info ms-auto">Nuevo</span>
                                        </t>
                                    </li>
                                    <li class="list-group-item d-flex align-items-center"
                                        t-att-class="'list-group-item-success' if billing_request.progress >= 60 else ''">
                                        <t t-if="billing_request.progress >= 60">
                                            <i class="fa fa-check-circle text-success me-3"></i>
                                        </t>
                                        <t t-elif="billing_request.state == 'creating_invoice'">
                                            <div class="spinner-border spinner-border-sm text-primary me-3"></div>
                                        </t>
                                        <t t-else="">
                                            <i class="fa fa-circle text-muted me-3"></i>
                                        </t>
                                        <span>Creación de Factura</span>
                                    </li>
                                    <li class="list-group-item d-flex align-items-center"
                                        t-att-class="'list-group-item-success' if billing_request.progress >= 80 else ''">
                                        <t t-if="billing_request.progress >= 80">
                                            <i class="fa fa-check-circle text-success me-3"></i>
                                        </t>
                                        <t t-elif="billing_request.state == 'pending_stamp'">
                                            <div class="spinner-border spinner-border-sm text-warning me-3"></div>
                                        </t>
                                        <t t-else="">
                                            <i class="fa fa-circle text-muted me-3"></i>
                                        </t>
                                        <span>Timbrado CFDI</span>
                                        <t t-if="billing_request.state == 'pending_stamp'">
                                            <span class="badge bg-warning ms-auto">En revisión</span>
                                        </t>
                                    </li>
                                    <li class="list-group-item d-flex align-items-center"
                                        t-att-class="'list-group-item-success' if billing_request.state == 'done' else ''">
                                        <t t-if="billing_request.state == 'done'">
                                            <i class="fa fa-check-circle text-success me-3"></i>
                                        </t>
                                        <t t-else="">
                                            <i class="fa fa-circle text-muted me-3"></i>
                                        </t>
                                        <span>Envío por Email</span>
                                    </li>
                                </ul>
                            </div>

                            <!-- Información de factura (si existe) -->
                            <t t-if="billing_request.invoice_id">
                                <div class="alert alert-success mt-4">
                                    <h6 class="alert-heading">
                                        <i class="fa fa-file-invoice me-2"></i>
                                        Factura Generada
                                    </h6>
                                    <p class="mb-0">
                                        Número de factura: <strong><t t-esc="billing_request.invoice_name"/></strong>
                                    </p>
                                    <t t-if="billing_request.folio_fiscal">
                                        <p class="mb-0 mt-2">
                                            Folio Fiscal (UUID): <code><t t-esc="billing_request.folio_fiscal"/></code>
                                        </p>
                                    </t>
                                    <hr/>
                                    <t t-if="billing_request.state == 'pending_stamp'">
                                        <p class="mb-0 small">
                                            La factura será enviada a <strong><t t-esc="billing_request.email"/></strong>
                                            una vez que sea timbrada por el área de contabilidad.
                                        </p>
                                    </t>
                                    <t t-if="billing_request.state == 'done' or billing_request.folio_fiscal">
                                        <div class="d-flex gap-2 mt-3">
                                            <a t-att-href="'/portal/billing/download/xml/%d' % billing_request.id"
                                               class="btn btn-outline-primary btn-sm"
                                               t-if="billing_request.has_cfdi_files">
                                                <i class="fa fa-file-code-o me-1"></i> Descargar XML
                                            </a>
                                            <a t-att-href="'/portal/billing/download/pdf/%d' % billing_request.id"
                                               class="btn btn-outline-danger btn-sm">
                                                <i class="fa fa-file-pdf-o me-1"></i> Descargar PDF
                                            </a>
                                        </div>
                                    </t>
                                </div>
                            </t>

                            <!-- Error (si existe) -->
                            <t t-if="billing_request.state == 'error' and billing_request.error_message">
                                <div class="alert alert-danger mt-4">
                                    <h6 class="alert-heading">
                                        <i class="fa fa-exclamation-triangle me-2"></i>
                                        Detalle del Error
                                    </h6>
                                    <p class="mb-0"><t t-esc="billing_request.error_message"/></p>
                                </div>
                            </t>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex justify-content-between">
                                <a href="/portal/billing/orders" class="btn btn-outline-secondary">
                                    <i class="fa fa-arrow-left me-1"></i> Volver a Órdenes
                                </a>
                                <t t-if="billing_request.state not in ('done', 'error', 'cancelled')">
                                    <button type="button"
                                            class="btn btn-outline-primary"
                                            id="btnRefresh"
                                            onclick="location.reload()">
                                        <i class="fa fa-sync me-1"></i> Actualizar
                                    </button>
                                </t>
                            </div>
                        </div>
                    </div>

                    <!-- Sección de Mensajería Cliente-Contador -->
                    <div class="card mt-4" id="messaging-section"
                         t-att-class="'card border-primary' if billing_request.state == 'pending_stamp' else 'card'">
                        <div t-att-class="'card-header bg-primary text-white' if billing_request.state == 'pending_stamp' else 'card-header'">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fa fa-comments me-2"></i>
                                    Chat con Contabilidad
                                </h6>
                                <t t-if="billing_request.state == 'pending_stamp'">
                                    <span class="badge bg-light text-primary">Disponible</span>
                                </t>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Mensaje de bienvenida para pending_stamp -->
                            <t t-if="billing_request.state == 'pending_stamp' and not billing_request.message_to_client and not billing_request.message_from_client">
                                <div class="text-center text-muted mb-3 py-2">
                                    <i class="fa fa-comment-o fa-2x mb-2 d-block"></i>
                                    <p class="mb-0">¿Necesita hacer algun cambio o tiene alguna pregunta?</p>
                                    <small>Escriba su mensaje y el area de contabilidad le respondera.</small>
                                </div>
                            </t>

                            <!-- Respuesta del contador (si existe) -->
                            <t t-if="billing_request.message_to_client">
                                <div class="alert alert-info mb-3">
                                    <div class="d-flex">
                                        <i class="fa fa-user-circle fa-2x me-3 text-info"></i>
                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between">
                                                <strong>Contabilidad:</strong>
                                                <small class="text-muted">
                                                    <t t-if="billing_request.last_message_date">
                                                        <t t-esc="billing_request.last_message_date" t-options="{'widget': 'datetime'}"/>
                                                    </t>
                                                </small>
                                            </div>
                                            <p class="mb-0 mt-1"><t t-esc="billing_request.message_to_client"/></p>
                                        </div>
                                    </div>
                                </div>
                            </t>

                            <!-- Mensaje anterior del cliente -->
                            <t t-if="billing_request.message_from_client">
                                <div class="alert alert-secondary mb-3">
                                    <div class="d-flex">
                                        <i class="fa fa-user fa-2x me-3"></i>
                                        <div>
                                            <strong>Tu mensaje:</strong>
                                            <p class="mb-0 mt-1"><t t-esc="billing_request.message_from_client"/></p>
                                        </div>
                                    </div>
                                </div>
                            </t>

                            <!-- Formulario para enviar mensaje -->
                            <t t-if="billing_request.state in ('pending_stamp', 'error')">
                                <form id="messageForm">
                                    <div class="mb-3">
                                        <textarea class="form-control" id="clientMessage" rows="3"
                                                  placeholder="Escriba su mensaje o consulta aqui... Ejemplo: 'Necesito cambiar el uso de CFDI' o '¿Cuando estara lista mi factura?'"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100" id="btnSendMessage">
                                        <i class="fa fa-paper-plane me-1"></i> Enviar Mensaje a Contabilidad
                                    </button>
                                </form>
                            </t>
                            <t t-if="billing_request.state == 'done'">
                                <div class="text-center text-success py-3">
                                    <i class="fa fa-check-circle fa-2x mb-2 d-block"></i>
                                    <p class="mb-0">Su factura ha sido timbrada y enviada.</p>
                                    <small class="text-muted">Revise su correo electronico.</small>
                                </div>
                            </t>
                            <t t-if="billing_request.state not in ('pending_stamp', 'error', 'done')">
                                <div class="text-center text-muted py-3">
                                    <i class="fa fa-hourglass-half fa-2x mb-2 d-block"></i>
                                    <p class="mb-0">El chat estara disponible una vez que su solicitud este en revision.</p>
                                </div>
                            </t>
                        </div>
                    </div>

                    <!-- Información adicional -->
                    <div class="card mt-4">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fa fa-info-circle me-2"></i>
                                Información de la Solicitud
                            </h6>
                            <table class="table table-sm table-borderless mb-0">
                                <tr>
                                    <td class="text-muted">Fecha:</td>
                                    <td><t t-esc="billing_request.create_date" t-options="{'widget': 'datetime'}"/></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Órdenes:</td>
                                    <td><t t-esc="', '.join(billing_request.order_ids.mapped('name'))"/></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">RFC:</td>
                                    <td><code><t t-esc="billing_request.rfc or '-'"/></code></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Email:</td>
                                    <td><t t-esc="billing_request.email"/></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Script para actualización automática y mensajería -->
            <script>
                (function() {
                    var requestId = <t t-esc="billing_request.id"/>;
                    var state = '<t t-esc="billing_request.state"/>';

                    // Auto-refresh si está en proceso
                    if (['draft', 'validating', 'csf_validated', 'creating_partner', 'creating_invoice'].includes(state)) {
                        setTimeout(function() {
                            location.reload();
                        }, 5000);
                    }

                    // Manejar envío de mensajes
                    var messageForm = document.getElementById('messageForm');
                    if (messageForm) {
                        messageForm.addEventListener('submit', function(e) {
                            e.preventDefault();

                            var messageInput = document.getElementById('clientMessage');
                            var message = messageInput.value.trim();

                            if (!message) {
                                alert('Por favor escriba un mensaje');
                                return;
                            }

                            var btn = document.getElementById('btnSendMessage');
                            btn.disabled = true;
                            btn.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i> Enviando...';

                            fetch('/portal/billing/api/send-message/' + requestId, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    jsonrpc: '2.0',
                                    method: 'call',
                                    params: { message: message },
                                    id: Math.floor(Math.random() * 1000000000),
                                }),
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.result &amp;&amp; data.result.success) {
                                    // Mostrar éxito y recargar
                                    alert('Mensaje enviado correctamente');
                                    location.reload();
                                } else {
                                    var errors = data.result &amp;&amp; data.result.errors ? data.result.errors.join(', ') : 'Error desconocido';
                                    alert('Error: ' + errors);
                                    btn.disabled = false;
                                    btn.innerHTML = '<i class="fa fa-paper-plane me-1"></i> Enviar Mensaje';
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('Error de conexión');
                                btn.disabled = false;
                                btn.innerHTML = '<i class="fa fa-paper-plane me-1"></i> Enviar Mensaje';
                            });
                        });
                    }
                })();
            </script>
        </t>
    </template>
</odoo>
