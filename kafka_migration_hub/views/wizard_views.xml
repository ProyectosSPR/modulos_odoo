<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista Form del Wizard de Prueba de Conexión -->
    <record id="connection_test_wizard_view_form" model="ir.ui.view">
        <field name="name">migration.connection.test.wizard.form</field>
        <field name="model">migration.connection.test.wizard</field>
        <field name="arch" type="xml">
            <form string="Probar Conexión">
                <group attrs="{'invisible': [('test_result', '=', 'pending')]}">
                    <div class="alert alert-success" role="alert"
                         attrs="{'invisible': [('test_result', '!=', 'success')]}">
                        <i class="fa fa-check-circle"/> Conexión exitosa
                    </div>
                    <div class="alert alert-danger" role="alert"
                         attrs="{'invisible': [('test_result', '!=', 'failed')]}">
                        <i class="fa fa-times-circle"/> Conexión fallida
                    </div>
                </group>
                <group>
                    <field name="connection_id" readonly="1"/>
                    <field name="test_result" invisible="1"/>
                </group>
                <group attrs="{'invisible': [('test_result', '=', 'pending')]}">
                    <field name="test_message" readonly="1"/>
                </group>
                <group string="Información de la Base de Datos"
                       attrs="{'invisible': [('test_result', '!=', 'success')]}">
                    <group>
                        <field name="database_version" readonly="1"/>
                        <field name="database_size" readonly="1"/>
                    </group>
                    <group>
                        <field name="table_count" readonly="1"/>
                    </group>
                </group>
                <group attrs="{'invisible': [('test_result', '!=', 'success')]}">
                    <field name="test_details" nolabel="1" readonly="1"/>
                </group>
                <footer>
                    <button name="action_test_connection" type="object"
                            string="Probar Conexión" class="btn-primary"
                            attrs="{'invisible': [('test_result', '!=', 'pending')]}"/>
                    <button name="action_test_connection" type="object"
                            string="Reintentar" class="btn-warning"
                            attrs="{'invisible': [('test_result', '=', 'pending')]}"/>
                    <button name="action_proceed_to_project" type="object"
                            string="Crear Proyecto" class="btn-success"
                            attrs="{'invisible': [('test_result', '!=', 'success')]}"/>
                    <button string="Cerrar" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Acción del Wizard de Prueba de Conexión -->
    <record id="connection_test_wizard_action" model="ir.actions.act_window">
        <field name="name">Probar Conexión</field>
        <field name="res_model">migration.connection.test.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
    </record>

    <!-- Vista Form del Wizard de Mapeo con IA -->
    <record id="ai_mapping_wizard_view_form" model="ir.ui.view">
        <field name="name">migration.ai.mapping.wizard.form</field>
        <field name="model">migration.ai.mapping.wizard</field>
        <field name="arch" type="xml">
            <form string="Asistente de Mapeo con IA">
                <header>
                    <field name="state" widget="statusbar"
                           statusbar_visible="config,analyzing,results,done"/>
                </header>
                <sheet>
                    <!-- Paso 1: Configuración -->
                    <group attrs="{'invisible': [('state', '!=', 'config')]}">
                        <group string="Proyecto">
                            <field name="project_id" readonly="1"/>
                        </group>
                        <group string="Proveedor de IA">
                            <field name="ai_provider" widget="radio"/>
                            <field name="api_key" password="True"
                                   placeholder="sk-..."
                                   attrs="{'invisible': [('ai_provider', '=', 'heuristic')]}"/>
                        </group>
                        <group string="Opciones de Análisis">
                            <field name="analyze_tables"/>
                            <field name="analyze_fields"/>
                            <field name="analyze_relationships"/>
                            <field name="min_confidence" widget="percentage"/>
                        </group>
                    </group>

                    <!-- Paso 2: Analizando -->
                    <group attrs="{'invisible': [('state', '!=', 'analyzing')]}">
                        <div class="text-center">
                            <h3><i class="fa fa-spinner fa-spin"/> Analizando...</h3>
                            <field name="current_step" readonly="1"/>
                            <field name="progress" widget="progressbar"/>
                        </div>
                    </group>

                    <!-- Paso 3: Resultados -->
                    <group attrs="{'invisible': [('state', 'not in', ['results', 'done'])]}">
                        <field name="results_html" nolabel="1" readonly="1"/>
                    </group>

                    <notebook attrs="{'invisible': [('state', 'not in', ['results', 'done'])]}">
                        <page string="Sugerencias de Tablas" name="table_suggestions">
                            <field name="suggestion_ids" nolabel="1"
                                   domain="[('suggestion_type', '=', 'table')]">
                                <tree editable="bottom"
                                      decoration-success="confidence >= 0.8"
                                      decoration-warning="confidence >= 0.6 and confidence &lt; 0.8"
                                      decoration-danger="confidence &lt; 0.6">
                                    <field name="selected" widget="boolean_toggle"/>
                                    <field name="source_name"/>
                                    <field name="suggested_topic_id"/>
                                    <field name="confidence" widget="progressbar"/>
                                    <field name="reason"/>
                                    <field name="suggestion_type" invisible="1"/>
                                </tree>
                            </field>
                        </page>
                        <page string="Sugerencias de Campos" name="field_suggestions">
                            <field name="suggestion_ids" nolabel="1"
                                   domain="[('suggestion_type', '=', 'field')]">
                                <tree editable="bottom"
                                      decoration-success="confidence >= 0.8"
                                      decoration-warning="confidence >= 0.6 and confidence &lt; 0.8"
                                      decoration-danger="confidence &lt; 0.6">
                                    <field name="selected" widget="boolean_toggle"/>
                                    <field name="table_mapping_id"/>
                                    <field name="source_name"/>
                                    <field name="suggested_value"/>
                                    <field name="transform_function"/>
                                    <field name="confidence" widget="progressbar"/>
                                    <field name="suggestion_type" invisible="1"/>
                                </tree>
                            </field>
                        </page>
                    </notebook>

                    <!-- Estadísticas -->
                    <group string="Estadísticas" attrs="{'invisible': [('state', 'not in', ['results', 'done'])]}">
                        <group>
                            <field name="tables_analyzed" readonly="1"/>
                            <field name="fields_mapped" readonly="1"/>
                        </group>
                        <group>
                            <field name="high_confidence_count" readonly="1"/>
                            <field name="medium_confidence_count" readonly="1"/>
                            <field name="low_confidence_count" readonly="1"/>
                        </group>
                    </group>
                </sheet>
                <footer>
                    <!-- Configuración -->
                    <button name="action_start_analysis" type="object"
                            string="Iniciar Análisis" class="btn-primary"
                            attrs="{'invisible': [('state', '!=', 'config')]}"/>

                    <!-- Resultados -->
                    <button name="action_select_all_high" type="object"
                            string="Seleccionar Alta Confianza" class="btn-info"
                            attrs="{'invisible': [('state', '!=', 'results')]}"/>
                    <button name="action_deselect_all" type="object"
                            string="Deseleccionar Todo" class="btn-secondary"
                            attrs="{'invisible': [('state', '!=', 'results')]}"/>
                    <button name="action_apply_selected" type="object"
                            string="Aplicar Seleccionadas" class="btn-success"
                            attrs="{'invisible': [('state', '!=', 'results')]}"/>

                    <button string="Cerrar" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Acción del Wizard de Mapeo con IA -->
    <record id="ai_mapping_wizard_action" model="ir.actions.act_window">
        <field name="name">Asistente de Mapeo con IA</field>
        <field name="res_model">migration.ai.mapping.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
    </record>
</odoo>
