<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ============================================= -->
    <!-- EXTENSION VISTA PAGOS -->
    <!-- ============================================= -->

    <!-- Extend Payment Form -->
    <record id="view_mercadolibre_payment_form_claims" model="ir.ui.view">
        <field name="name">mercadolibre.payment.form.claims</field>
        <field name="model">mercadolibre.payment</field>
        <field name="inherit_id" ref="mercadolibre_payments.view_mercadolibre_payment_form"/>
        <field name="arch" type="xml">
            <!-- Agregar boton de reclamos en button_box -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_view_claims" type="object"
                        class="oe_stat_button" icon="fa-exclamation-triangle"
                        attrs="{'invisible': [('claim_count', '=', 0)]}">
                    <field name="claim_count" widget="statinfo" string="Reclamos"/>
                </button>
            </xpath>

            <!-- Agregar seccion de mediacion despues de los campos de estado -->
            <xpath expr="//field[@name='status']/.." position="after">
                <group string="Estado de Mediacion"
                       attrs="{'invisible': [('mediation_status', '=', 'none')]}">
                    <group>
                        <field name="mediation_status"/>
                        <field name="mediation_date"/>
                    </group>
                    <group>
                        <field name="mediation_action_taken"/>
                        <field name="mediation_resolution_date"
                               attrs="{'invisible': [('mediation_resolution_date', '=', False)]}"/>
                    </group>
                </group>
            </xpath>

            <!-- Agregar boton para buscar claims -->
            <xpath expr="//header" position="inside">
                <button name="action_search_claims" type="object"
                        string="Buscar Reclamos" icon="fa-search"
                        attrs="{'invisible': [('status', '!=', 'in_mediation')]}"/>
            </xpath>
        </field>
    </record>

    <!-- Extend Payment Tree -->
    <record id="view_mercadolibre_payment_tree_claims" model="ir.ui.view">
        <field name="name">mercadolibre.payment.tree.claims</field>
        <field name="model">mercadolibre.payment</field>
        <field name="inherit_id" ref="mercadolibre_payments.view_mercadolibre_payment_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='status']" position="after">
                <field name="mediation_status" optional="hide"/>
                <field name="claim_count" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- Extend Payment Search -->
    <record id="view_mercadolibre_payment_search_claims" model="ir.ui.view">
        <field name="name">mercadolibre.payment.search.claims</field>
        <field name="model">mercadolibre.payment</field>
        <field name="inherit_id" ref="mercadolibre_payments.view_mercadolibre_payment_search"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='filter_approved']" position="after">
                <separator/>
                <filter name="filter_in_mediation" string="En Mediacion"
                        domain="[('status', '=', 'in_mediation')]"/>
                <filter name="filter_has_claim" string="Con Reclamos"
                        domain="[('claim_count', '>', 0)]"/>
            </xpath>
            <xpath expr="//search" position="inside">
                <group expand="0" string="Agrupar por Mediacion">
                    <filter name="group_mediation_status" string="Estado Mediacion"
                            context="{'group_by': 'mediation_status'}"/>
                </group>
            </xpath>
        </field>
    </record>

    <!-- Action - Pagos en Mediacion -->
    <record id="action_mercadolibre_payment_in_mediation" model="ir.actions.act_window">
        <field name="name">Pagos en Mediacion</field>
        <field name="res_model">mercadolibre.payment</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('status', '=', 'in_mediation')]</field>
        <field name="context">{}</field>
    </record>

</odoo>
