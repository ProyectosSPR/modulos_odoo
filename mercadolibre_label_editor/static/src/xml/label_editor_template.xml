<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <t t-name="mercadolibre_label_editor.LabelEditorWidget" owl="1">
        <div class="o_label_editor_widget" style="max-width: 1200px; margin: 0 auto;">

            <!-- Información del PDF -->
            <div class="o_label_editor_info" style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-around; flex-wrap: wrap;">
                    <div style="margin: 5px 10px;">
                        <strong>Dimensiones:</strong>
                        <span style="font-family: monospace;"><t t-esc="displayInfo.width"/> x <t t-esc="displayInfo.height"/> px</span>
                    </div>
                    <div style="margin: 5px 10px;">
                        <strong>Campos configurados:</strong>
                        <span style="font-family: monospace;"><t t-esc="displayInfo.fieldCount"/></span>
                    </div>
                </div>
            </div>

            <!-- Canvas para renderizar PDF -->
            <div class="o_label_editor_canvas_container" style="background: #f5f5f5; padding: 30px; border-radius: 8px; text-align: center; min-height: 400px; display: flex; align-items: center; justify-content: center;">
                <!-- Contenedor con posición relativa para el overlay -->
                <div style="position: relative; display: inline-block;">
                    <!-- Canvas siempre presente en DOM -->
                    <canvas t-ref="pdfCanvas"
                            t-on-mousemove="onCanvasMouseMove"
                            t-on-mouseleave="onCanvasMouseLeave"
                            t-on-click="onCanvasClick"
                            t-att-style="state.pdfLoaded ? 'border: 1px solid #ccc; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: white; max-width: 100%; height: auto; cursor: crosshair; display: block;' : 'display: none;'"/>

                    <!-- Overlay para mostrar campos configurados (solo visible cuando PDF está cargado) -->
                    <svg t-if="state.pdfLoaded"
                         t-ref="fieldOverlay"
                         t-att-width="props.record.data.pdf_width * state.scale"
                         t-att-height="props.record.data.pdf_height * state.scale"
                         t-att-viewBox="`0 0 ${props.record.data.pdf_width} ${props.record.data.pdf_height}`"
                         style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">

                        <!-- Renderizar cada campo configurado -->
                        <t t-foreach="configuredFields" t-as="field" t-key="field.id">
                            <!-- Grupo para cada campo (las coordenadas field.x y field.y son del PDF sin escala) -->
                            <g t-att-id="'field_' + field.id">
                                <!-- Círculo marcador -->
                                <circle t-att-cx="field.x" t-att-cy="field.y" r="3.5"
                                        fill="red" opacity="0.85" stroke="white" stroke-width="0.8"/>

                                <!-- Texto del campo (renderizado en tiempo real) -->
                                <text t-att-x="field.x" t-att-y="field.y - 7"
                                      t-att-fill="field.color"
                                      t-att-font-size="field.fontSize"
                                      t-att-font-family="field.fontFamily"
                                      t-att-text-anchor="field.align === 'center' ? 'middle' : (field.align === 'right' ? 'end' : 'start')"
                                      opacity="0.9"
                                      stroke="white" stroke-width="0.3">
                                    <t t-esc="field.value"/>
                                </text>

                                <!-- Etiqueta con nombre del campo (identificador) -->
                                <text t-att-x="field.x + 6" t-att-y="field.y + 3"
                                      fill="white" font-size="9"
                                      font-family="Arial, sans-serif"
                                      font-weight="bold"
                                      stroke="red" stroke-width="2"
                                      paint-order="stroke"
                                      opacity="0.95">
                                    <t t-esc="field.name"/>
                                </text>
                            </g>
                        </t>
                    </svg>

                    <!-- Indicador de coordenadas del mouse (solo visible cuando PDF está cargado) -->
                    <div t-if="state.pdfLoaded and state.showCoordinates"
                         style="position: absolute; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.8); color: white; padding: 8px 12px; border-radius: 4px; font-family: monospace; font-size: 14px; pointer-events: none; z-index: 1000;">
                        X: <t t-esc="state.mouseX"/> px | Y: <t t-esc="state.mouseY"/> px
                    </div>
                </div>

                <!-- Mensaje cuando no hay PDF cargado -->
                <div t-if="!state.pdfLoaded and !state.error" style="max-width: 600px; padding: 40px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="text-align: center;">
                        <i class="fa fa-file-pdf-o" style="font-size: 64px; color: #999; margin-bottom: 20px;"/>
                        <h4 style="color: #333; margin-bottom: 10px;">Vista Previa No Disponible</h4>
                        <p style="color: #666; margin-bottom: 20px;">
                            El editor visual requiere que primero cargues un PDF en la pestaña principal.<br/>
                            Vuelve al formulario principal y sube un PDF de ejemplo de etiqueta ML.
                        </p>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107;">
                            <p style="margin: 0; color: #856404; font-size: 14px;">
                                <strong>Sugerencia:</strong> Mientras tanto, puedes usar la pestaña "Campos de Texto"
                                en el formulario principal para configurar los campos.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Mensaje de error -->
                <div t-if="state.error" style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; border: 1px solid #f5c6cb; max-width: 600px;">
                    <strong>Error al cargar PDF:</strong> <t t-esc="state.error"/>
                </div>
            </div>

            <!-- Instrucciones -->
            <div class="o_label_editor_instructions" style="background: #d4edda; padding: 20px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #28a745;">
                <h6 style="margin-top: 0; color: #155724;">
                    <i class="fa fa-lightbulb-o"/> Cómo usar el editor interactivo:
                </h6>
                <ol style="margin-bottom: 0; padding-left: 20px; color: #155724;">
                    <li style="margin-bottom: 8px;"><strong>Mueve el mouse</strong> sobre el PDF para ver las coordenadas X,Y en tiempo real (esquina superior derecha)</li>
                    <li style="margin-bottom: 8px;"><strong>Haz click</strong> en cualquier punto del PDF para copiar las coordenadas al portapapeles</li>
                    <li style="margin-bottom: 8px;">Los <strong>campos configurados</strong> aparecen automáticamente sobre el PDF con un punto rojo y su nombre</li>
                    <li style="margin-bottom: 8px;">Ve a la sección <strong>"Campos Configurados"</strong> abajo para agregar o editar campos</li>
                    <li style="margin-bottom: 8px;">Usa variables como <code style="background: white; padding: 2px 6px; border-radius: 3px;">${sale_order.name}</code> para datos dinámicos</li>
                    <li style="margin-bottom: 0;">Los cambios se reflejan <strong>inmediatamente</strong> en el preview del PDF</li>
                </ol>
            </div>
        </div>
    </t>

</templates>
