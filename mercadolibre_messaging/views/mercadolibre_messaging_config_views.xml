<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Config Tree View -->
    <record id="mercadolibre_messaging_config_view_tree" model="ir.ui.view">
        <field name="name">mercadolibre.messaging.config.tree</field>
        <field name="model">mercadolibre.messaging.config</field>
        <field name="arch" type="xml">
            <tree string="Configuración de Mensajería">
                <field name="sequence" widget="handle"/>
                <field name="name"/>
                <field name="account_id"/>
                <field name="schedule_id"/>
                <field name="auto_messages_enabled" widget="boolean_toggle"/>
                <field name="messages_sent_today"/>
                <field name="messages_sent_week"/>
                <field name="last_sync_date"/>
                <field name="active" widget="boolean_toggle"/>
            </tree>
        </field>
    </record>

    <!-- Config Form View -->
    <record id="mercadolibre_messaging_config_view_form" model="ir.ui.view">
        <field name="name">mercadolibre.messaging.config.form</field>
        <field name="model">mercadolibre.messaging.config</field>
        <field name="arch" type="xml">
            <form string="Configuración de Mensajería ML">
                <header>
                    <button name="action_test_connection" type="object" string="Probar Conexión"
                            class="btn-secondary" icon="fa-plug"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" icon="fa-envelope">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_value"><field name="messages_sent_today"/></span>
                                <span class="o_stat_text">Mensajes Hoy</span>
                            </div>
                        </button>
                        <button class="oe_stat_button" icon="fa-question-circle"
                                name="action_view_pending_questions" type="object">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_value"><field name="questions_pending_count"/></span>
                                <span class="o_stat_text">Preguntas Pendientes</span>
                            </div>
                        </button>
                        <button class="oe_stat_button" icon="fa-check-circle">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_value"><field name="questions_answered_today"/></span>
                                <span class="o_stat_text">Respondidas Hoy</span>
                            </div>
                        </button>
                    </div>
                    <widget name="web_ribbon" title="Desactivado" bg_color="bg-danger"
                            attrs="{'invisible': [('active', '=', True)]}"/>
                    <div class="oe_title">
                        <label for="name"/>
                        <h1>
                            <field name="name"/>
                        </h1>
                    </div>

                    <group>
                        <group string="Cuenta">
                            <field name="account_id"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                            <field name="active" widget="boolean_toggle"/>
                        </group>
                        <group string="Horario">
                            <field name="schedule_id"/>
                            <field name="queue_out_of_hours" widget="boolean_toggle"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Funcionalidades" name="features">
                            <group>
                                <group string="Mensajes">
                                    <field name="auto_messages_enabled" widget="boolean_toggle"/>
                                    <field name="manual_messages_enabled" widget="boolean_toggle"/>
                                    <field name="sync_to_chatter" widget="boolean_toggle"/>
                                </group>
                                <group string="Preguntas">
                                    <field name="sync_questions" widget="boolean_toggle"/>
                                    <field name="notify_new_questions" widget="boolean_toggle"/>
                                </group>
                            </group>
                        </page>

                        <page string="Preguntas" name="questions">
                            <group>
                                <group string="Sincronización">
                                    <field name="sync_questions_interval"/>
                                    <button name="action_sync_questions" type="object"
                                            string="Sincronizar Ahora" class="btn-secondary"
                                            icon="fa-refresh"/>
                                </group>
                                <group string="Asignación y Notificaciones">
                                    <field name="question_auto_assign_user_id"/>
                                    <field name="question_notify_user_ids" widget="many2many_tags"/>
                                </group>
                            </group>

                            <separator string="Métricas de Tiempo de Respuesta (MercadoLibre)"/>
                            <group>
                                <group>
                                    <field name="question_response_time_total" string="Promedio General (min)"/>
                                    <field name="question_response_time_weekdays" string="Días Hábiles 9-18h (min)"/>
                                    <field name="question_response_time_weekdays_extra" string="Fuera de Horario 18-24h (min)"/>
                                    <field name="question_response_time_weekend" string="Fin de Semana (min)"/>
                                </group>
                                <group>
                                    <field name="question_sales_percent_increase" string="% Incremento Ventas (si &lt;1h)"/>
                                    <field name="questions_avg_response_time" string="T. Promedio Local (min)"/>
                                    <field name="question_metrics_last_update"/>
                                </group>
                            </group>

                            <div class="alert alert-info" role="alert">
                                <p><strong>Indicadores de MercadoLibre:</strong></p>
                                <ul class="mb-0">
                                    <li><strong>T. Respuesta:</strong> Tiempo promedio en minutos según ML (últimos 14 días)</li>
                                    <li><strong>Días hábiles:</strong> Lunes a Viernes 9am-6pm</li>
                                    <li><strong>Fuera de horario:</strong> Lunes a Viernes 6pm-12am</li>
                                    <li><strong>Fin de semana:</strong> Sábado y Domingo</li>
                                    <li><strong>% Incremento:</strong> Porcentaje estimado de aumento en ventas si respondes en &lt;1 hora</li>
                                </ul>
                            </div>
                        </page>

                        <page string="Reputación" name="reputation">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <button name="action_update_all_metrics" type="object"
                                            string="Actualizar Todas las Métricas" class="btn-primary"
                                            icon="fa-cloud-download"/>
                                </div>
                            </div>

                            <group col="4">
                                <group string="Nivel de Vendedor">
                                    <field name="seller_reputation_level"/>
                                    <field name="seller_reputation_power_seller"/>
                                    <field name="seller_reputation_last_update"/>
                                </group>
                                <group string="Transacciones">
                                    <field name="seller_transactions_period"/>
                                    <field name="seller_transactions_completed"/>
                                    <field name="seller_transactions_canceled"/>
                                </group>
                                <group string="Calificaciones (%)">
                                    <field name="seller_ratings_positive" widget="progressbar"/>
                                    <field name="seller_ratings_neutral"/>
                                    <field name="seller_ratings_negative"/>
                                </group>
                                <group string="Métricas de Calidad (%)">
                                    <field name="seller_claims_rate"/>
                                    <field name="seller_delayed_handling_rate"/>
                                    <field name="seller_cancellations_rate"/>
                                </group>
                            </group>

                            <div class="alert alert-warning" role="alert">
                                <p><strong>Métricas importantes para tu reputación:</strong></p>
                                <ul class="mb-0">
                                    <li><strong>Tasa de Reclamos:</strong> Debe ser menor al 4% (México) / 3% (Brasil)</li>
                                    <li><strong>Tasa de Demoras:</strong> El tiempo de despacho debe ser máximo 3 días</li>
                                    <li><strong>Tasa de Cancelaciones:</strong> Cancelaciones sin reclamo del comprador</li>
                                    <li><strong>Tiempo de Respuesta:</strong> Responder preguntas en &lt;1 hora mejora ventas</li>
                                </ul>
                            </div>
                        </page>

                        <page string="Límites" name="limits">
                            <group>
                                <group string="Ejecución">
                                    <field name="messages_per_cron"/>
                                    <field name="min_interval_minutes"/>
                                    <field name="rate_limit_per_minute"/>
                                </group>
                                <group string="Reintentos">
                                    <field name="max_retries"/>
                                    <field name="retry_delay_minutes"/>
                                </group>
                            </group>
                            <div class="alert alert-warning" role="alert">
                                <strong>Nota:</strong> MercadoLibre tiene un límite de 500 mensajes por minuto.
                                Se recomienda configurar un límite menor para evitar bloqueos.
                            </div>
                        </page>

                        <page string="Sincronización" name="sync">
                            <group>
                                <group string="Intervalos">
                                    <field name="sync_conversations_interval"/>
                                    <field name="sync_messages_interval"/>
                                </group>
                                <group string="Estado">
                                    <field name="last_sync_date"/>
                                </group>
                            </group>
                        </page>

                        <page string="Logging" name="logging">
                            <group>
                                <group string="Configuración">
                                    <field name="log_level"/>
                                    <field name="log_to_database" widget="boolean_toggle"/>
                                    <field name="log_api_requests" widget="boolean_toggle"/>
                                </group>
                            </group>
                            <div class="alert alert-info" role="alert">
                                <p><strong>Niveles de log:</strong></p>
                                <ul>
                                    <li><strong>Debug:</strong> Todos los mensajes, incluyendo detalles técnicos</li>
                                    <li><strong>Info:</strong> Operaciones normales y mensajes enviados/recibidos</li>
                                    <li><strong>Warning:</strong> Situaciones que requieren atención</li>
                                    <li><strong>Error:</strong> Solo errores y fallos</li>
                                </ul>
                                <p class="mb-0"><strong>Log API Requests:</strong> Guarda el contenido completo de las peticiones y respuestas de la API. Útil para debugging pero genera muchos datos.</p>
                            </div>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Config Action -->
    <record id="action_mercadolibre_messaging_config" model="ir.actions.act_window">
        <field name="name">Configuración</field>
        <field name="res_model">mercadolibre.messaging.config</field>
        <field name="view_mode">tree,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Configura la mensajería para tus cuentas de MercadoLibre
            </p>
            <p>
                Cada cuenta puede tener su propia configuración de horarios, límites y preferencias.
            </p>
        </field>
    </record>

</odoo>
