<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="view_mercadolibre_payment_tree" model="ir.ui.view">
        <field name="name">mercadolibre.payment.tree</field>
        <field name="model">mercadolibre.payment</field>
        <field name="arch" type="xml">
            <tree string="Pagos MercadoPago"
                  decoration-success="status=='approved' and money_release_status=='released'"
                  decoration-warning="status=='approved' and money_release_status=='pending'"
                  decoration-danger="status in ('rejected','cancelled','charged_back')"
                  decoration-info="status=='in_mediation'"
                  decoration-muted="status=='refunded'">
                <field name="name"/>
                <field name="account_id"/>
                <field name="mp_payment_id"/>
                <field name="payment_direction" widget="badge"
                       decoration-success="payment_direction=='incoming'"
                       decoration-info="payment_direction=='outgoing'"
                       decoration-muted="payment_direction=='unknown'"/>
                <field name="description" optional="hide"/>
                <field name="date_approved"/>
                <field name="transaction_amount" sum="Total"/>
                <field name="net_received_amount" sum="Total Neto"/>
                <field name="total_charges" sum="Total Cargos"/>
                <field name="payment_method_name"/>
                <field name="payer_email"/>
                <field name="status" widget="badge"
                       decoration-success="status=='approved'"
                       decoration-warning="status in ('pending','in_process')"
                       decoration-danger="status in ('rejected','cancelled','charged_back')"
                       decoration-info="status=='in_mediation'"/>
                <field name="money_release_status" widget="badge"
                       decoration-success="money_release_status=='released'"
                       decoration-warning="money_release_status=='pending'"
                       decoration-danger="money_release_status in ('not_released','unavailable')"/>
                <field name="sync_status" widget="badge"
                       decoration-success="sync_status=='synced'"
                       decoration-warning="sync_status=='pending'"
                       decoration-danger="sync_status=='error'"
                       decoration-muted="sync_status=='ignored'"/>
                <field name="odoo_payment_state" widget="badge"
                       decoration-success="odoo_payment_state=='created'"
                       decoration-warning="odoo_payment_state=='pending'"
                       decoration-danger="odoo_payment_state=='error'"
                       decoration-muted="odoo_payment_state=='skipped'"
                       optional="show"/>
                <field name="odoo_payment_id" optional="hide"/>
                <field name="matched_vendor_id" optional="hide"/>
                <field name="company_id" groups="base.group_multi_company"/>
            </tree>
        </field>
    </record>

    <record id="view_mercadolibre_payment_form" model="ir.ui.view">
        <field name="name">mercadolibre.payment.form</field>
        <field name="model">mercadolibre.payment</field>
        <field name="arch" type="xml">
            <form string="Pago MercadoPago">
                <header>
                    <button name="action_create_odoo_payment" type="object" string="Crear Pago Odoo"
                            class="btn-primary" icon="fa-money"
                            attrs="{'invisible': ['|', ('odoo_payment_id', '!=', False), ('status', '!=', 'approved')]}"/>
                    <button name="action_retry_odoo_payment" type="object" string="Reintentar Pago Odoo"
                            class="btn-warning"
                            attrs="{'invisible': [('odoo_payment_state', '!=', 'error')]}"/>
                    <button name="action_mark_synced" type="object" string="Marcar Sincronizado"
                            attrs="{'invisible': [('sync_status', 'in', ['synced', 'ignored'])]}"/>
                    <button name="action_mark_ignored" type="object" string="Ignorar"
                            attrs="{'invisible': [('sync_status', '=', 'ignored')]}"/>
                    <button name="action_retry_sync" type="object" string="Reintentar Sync"
                            attrs="{'invisible': [('sync_status', '!=', 'error')]}"/>
                    <field name="status" widget="statusbar"
                           statusbar_visible="pending,approved,rejected"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_odoo_payment" type="object"
                                class="oe_stat_button" icon="fa-money"
                                attrs="{'invisible': [('odoo_payment_id', '=', False)]}">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Ver Pago Odoo</span>
                            </div>
                        </button>
                        <button name="action_view_commission_payment" type="object"
                                class="oe_stat_button" icon="fa-percent"
                                attrs="{'invisible': [('commission_payment_id', '=', False)]}">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Ver Comision</span>
                            </div>
                        </button>
                        <button name="action_view_raw_data" type="object"
                                class="oe_stat_button" icon="fa-code">
                            <span>Ver JSON</span>
                        </button>
                    </div>
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>
                    <group>
                        <group string="Informacion General">
                            <field name="account_id"/>
                            <field name="mp_payment_id"/>
                            <field name="mp_order_id"/>
                            <field name="mp_external_reference"/>
                            <field name="payment_direction" widget="badge"
                                   decoration-success="payment_direction=='incoming'"
                                   decoration-info="payment_direction=='outgoing'"/>
                            <field name="operation_type"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                        </group>
                        <group string="Estado">
                            <field name="status"/>
                            <field name="status_detail"/>
                            <field name="money_release_status"/>
                            <field name="money_release_date"/>
                            <field name="sync_status"/>
                            <field name="sync_error" attrs="{'invisible': [('sync_error', '=', False)]}"/>
                            <field name="last_sync_date"/>
                        </group>
                    </group>
                    <group attrs="{'invisible': [('description', '=', False)]}">
                        <field name="description" nolabel="1" colspan="2"/>
                    </group>
                    <group>
                        <group string="Montos">
                            <field name="transaction_amount"/>
                            <field name="net_received_amount"/>
                            <field name="total_paid_amount"/>
                            <field name="shipping_cost"/>
                            <field name="total_charges"/>
                            <field name="currency_id"/>
                            <field name="mp_currency"/>
                        </group>
                        <group string="Metodo de Pago">
                            <field name="payment_method_id"/>
                            <field name="payment_method_name"/>
                            <field name="payment_type"/>
                            <field name="installments"/>
                        </group>
                    </group>
                    <group>
                        <group string="Fechas">
                            <field name="date_created"/>
                            <field name="date_approved"/>
                            <field name="date_last_updated"/>
                        </group>
                        <group string="Pagador">
                            <field name="payer_id"/>
                            <field name="payer_email"/>
                            <field name="payer_name"/>
                            <field name="payer_identification_type"/>
                            <field name="payer_identification_number"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Cargos/Comisiones" name="charges">
                            <field name="charge_ids">
                                <tree>
                                    <field name="charge_type_display" string="Tipo"/>
                                    <field name="charge_type" string="Codigo" optional="hide"/>
                                    <field name="fee_payer_display" string="Pagador"/>
                                    <field name="amount" sum="Total"/>
                                </tree>
                            </field>
                        </page>
                        <page string="Pago Odoo" name="odoo_payment">
                            <group>
                                <group string="Estado Pago Odoo">
                                    <field name="odoo_payment_state" widget="badge"
                                           decoration-success="odoo_payment_state=='created'"
                                           decoration-warning="odoo_payment_state=='pending'"
                                           decoration-danger="odoo_payment_state=='error'"
                                           decoration-muted="odoo_payment_state=='skipped'"/>
                                    <field name="odoo_payment_id"/>
                                    <field name="commission_payment_id"/>
                                </group>
                                <group string="Partner y Proveedor">
                                    <field name="partner_id"/>
                                    <field name="matched_vendor_id"/>
                                </group>
                            </group>
                            <group attrs="{'invisible': [('odoo_payment_error', '=', False)]}">
                                <field name="odoo_payment_error" nolabel="1" readonly="1"
                                       style="color: red;"/>
                            </group>
                            <div class="alert alert-success" role="alert"
                                 attrs="{'invisible': [('odoo_payment_state', '!=', 'created')]}">
                                <strong>Pago creado exitosamente.</strong>
                                Use los botones superiores para ver el pago en Odoo.
                            </div>
                            <div class="alert alert-warning" role="alert"
                                 attrs="{'invisible': [('odoo_payment_state', '!=', 'pending')]}">
                                <strong>Pago pendiente de creacion.</strong>
                                Use el boton "Crear Pago Odoo" para generar el pago en contabilidad.
                            </div>
                            <div class="alert alert-danger" role="alert"
                                 attrs="{'invisible': [('odoo_payment_state', '!=', 'error')]}">
                                <strong>Error al crear pago.</strong>
                                Revise el mensaje de error y use "Reintentar Pago Odoo".
                            </div>
                        </page>
                        <page string="Contabilidad Antigua" name="accounting">
                            <group>
                                <group>
                                    <field name="invoice_id"/>
                                </group>
                                <group>
                                    <field name="payment_move_id"/>
                                </group>
                            </group>
                        </page>
                        <page string="Notas" name="notes">
                            <field name="notes" placeholder="Notas adicionales..."/>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <record id="view_mercadolibre_payment_raw_form" model="ir.ui.view">
        <field name="name">mercadolibre.payment.raw.form</field>
        <field name="model">mercadolibre.payment</field>
        <field name="arch" type="xml">
            <form string="Datos Crudos">
                <sheet>
                    <group>
                        <field name="name" readonly="1"/>
                        <field name="mp_payment_id" readonly="1"/>
                    </group>
                    <separator string="JSON de MercadoPago"/>
                    <field name="raw_data" readonly="1" widget="ace" options="{'mode': 'json'}"/>
                </sheet>
            </form>
        </field>
    </record>

    <record id="view_mercadolibre_payment_search" model="ir.ui.view">
        <field name="name">mercadolibre.payment.search</field>
        <field name="model">mercadolibre.payment</field>
        <field name="arch" type="xml">
            <search string="Pagos MercadoPago">
                <field name="name"/>
                <field name="mp_payment_id"/>
                <field name="mp_order_id"/>
                <field name="payer_email"/>
                <field name="payer_name"/>
                <field name="account_id"/>
                <separator/>
                <filter string="Aprobados" name="approved" domain="[('status', '=', 'approved')]"/>
                <filter string="Pendientes" name="pending" domain="[('status', '=', 'pending')]"/>
                <filter string="En Mediacion" name="in_mediation" domain="[('status', '=', 'in_mediation')]"/>
                <filter string="Rechazados" name="rejected" domain="[('status', '=', 'rejected')]"/>
                <filter string="Reembolsados" name="refunded" domain="[('status', '=', 'refunded')]"/>
                <filter string="Contracargos" name="charged_back" domain="[('status', '=', 'charged_back')]"/>
                <separator/>
                <filter string="Pagos Recibidos" name="incoming"
                        domain="[('payment_direction', '=', 'incoming')]"/>
                <filter string="Pagos Realizados" name="outgoing"
                        domain="[('payment_direction', '=', 'outgoing')]"/>
                <separator/>
                <filter string="Dinero Liberado" name="released"
                        domain="[('money_release_status', '=', 'released')]"/>
                <filter string="Dinero Pendiente" name="release_pending"
                        domain="[('money_release_status', '=', 'pending')]"/>
                <separator/>
                <filter string="Sync Pendiente" name="sync_pending"
                        domain="[('sync_status', '=', 'pending')]"/>
                <filter string="Sincronizados" name="synced"
                        domain="[('sync_status', '=', 'synced')]"/>
                <filter string="Con Error" name="sync_error"
                        domain="[('sync_status', '=', 'error')]"/>
                <separator/>
                <filter string="Pago Odoo Pendiente" name="odoo_pending"
                        domain="[('odoo_payment_state', '=', 'pending')]"/>
                <filter string="Pago Odoo Creado" name="odoo_created"
                        domain="[('odoo_payment_state', '=', 'created')]"/>
                <filter string="Sin Pago Odoo" name="no_odoo_payment"
                        domain="[('odoo_payment_id', '=', False), ('status', '=', 'approved')]"/>
                <filter string="Error Pago Odoo" name="odoo_error"
                        domain="[('odoo_payment_state', '=', 'error')]"/>
                <separator/>
                <filter string="Hoy" name="today"
                        domain="[('date_approved', '>=', (context_today()).strftime('%Y-%m-%d')),
                                 ('date_approved', '&lt;', (context_today() + relativedelta(days=1)).strftime('%Y-%m-%d'))]"/>
                <filter string="Esta Semana" name="this_week"
                        domain="[('date_approved', '>=', (context_today() - relativedelta(days=context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                <filter string="Este Mes" name="this_month"
                        domain="[('date_approved', '>=', (context_today()).strftime('%Y-%m-01'))]"/>
                <separator/>
                <group expand="0" string="Agrupar por">
                    <filter string="Cuenta" name="group_account" context="{'group_by': 'account_id'}"/>
                    <filter string="Direccion" name="group_direction" context="{'group_by': 'payment_direction'}"/>
                    <filter string="Estado" name="group_status" context="{'group_by': 'status'}"/>
                    <filter string="Liberacion" name="group_release" context="{'group_by': 'money_release_status'}"/>
                    <filter string="Metodo Pago" name="group_method" context="{'group_by': 'payment_type'}"/>
                    <filter string="Fecha Aprobacion" name="group_date" context="{'group_by': 'date_approved:month'}"/>
                    <filter string="Estado Sync" name="group_sync" context="{'group_by': 'sync_status'}"/>
                    <filter string="Estado Pago Odoo" name="group_odoo_state" context="{'group_by': 'odoo_payment_state'}"/>
                    <filter string="Proveedor Detectado" name="group_vendor" context="{'group_by': 'matched_vendor_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <record id="view_mercadolibre_payment_kanban" model="ir.ui.view">
        <field name="name">mercadolibre.payment.kanban</field>
        <field name="model">mercadolibre.payment</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" default_group_by="status">
                <field name="name"/>
                <field name="mp_payment_id"/>
                <field name="transaction_amount"/>
                <field name="net_received_amount"/>
                <field name="status"/>
                <field name="money_release_status"/>
                <field name="payer_email"/>
                <field name="date_approved"/>
                <field name="payment_method_name"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click">
                            <div class="o_kanban_record_top mb-2">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="name"/>
                                    </strong>
                                </div>
                                <div class="o_kanban_record_top_right">
                                    <strong class="text-success">
                                        $<field name="transaction_amount"/>
                                    </strong>
                                </div>
                            </div>
                            <div class="o_kanban_record_body">
                                <div><i class="fa fa-user mr-1"/> <field name="payer_email"/></div>
                                <div><i class="fa fa-credit-card mr-1"/> <field name="payment_method_name"/></div>
                                <div><i class="fa fa-calendar mr-1"/> <field name="date_approved"/></div>
                            </div>
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <field name="money_release_status" widget="badge"
                                           decoration-success="money_release_status=='released'"
                                           decoration-warning="money_release_status=='pending'"/>
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    Neto: $<field name="net_received_amount"/>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <record id="view_mercadolibre_payment_pivot" model="ir.ui.view">
        <field name="name">mercadolibre.payment.pivot</field>
        <field name="model">mercadolibre.payment</field>
        <field name="arch" type="xml">
            <pivot string="Pagos MercadoPago">
                <field name="date_approved" type="row" interval="month"/>
                <field name="status" type="col"/>
                <field name="transaction_amount" type="measure"/>
                <field name="net_received_amount" type="measure"/>
                <field name="total_charges" type="measure"/>
            </pivot>
        </field>
    </record>

    <record id="view_mercadolibre_payment_graph" model="ir.ui.view">
        <field name="name">mercadolibre.payment.graph</field>
        <field name="model">mercadolibre.payment</field>
        <field name="arch" type="xml">
            <graph string="Pagos MercadoPago" type="bar">
                <field name="date_approved" type="row" interval="month"/>
                <field name="transaction_amount" type="measure"/>
            </graph>
        </field>
    </record>

    <record id="action_mercadolibre_payment" model="ir.actions.act_window">
        <field name="name">Pagos</field>
        <field name="res_model">mercadolibre.payment</field>
        <field name="view_mode">tree,kanban,form,pivot,graph</field>
        <field name="context">{'search_default_approved': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay pagos sincronizados
            </p>
            <p>
                Utiliza el asistente de sincronizacion para importar pagos desde MercadoPago.
            </p>
        </field>
    </record>

    <record id="action_mercadolibre_payment_released" model="ir.actions.act_window">
        <field name="name">Pagos Liberados</field>
        <field name="res_model">mercadolibre.payment</field>
        <field name="view_mode">tree,kanban,form,pivot,graph</field>
        <field name="domain">[('money_release_status', '=', 'released')]</field>
        <field name="context">{'search_default_approved': 1}</field>
    </record>

    <record id="action_mercadolibre_payment_pending_sync" model="ir.actions.act_window">
        <field name="name">Pendientes de Sincronizar</field>
        <field name="res_model">mercadolibre.payment</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('sync_status', '=', 'pending')]</field>
    </record>

    <record id="action_mercadolibre_payment_incoming" model="ir.actions.act_window">
        <field name="name">Pagos Recibidos</field>
        <field name="res_model">mercadolibre.payment</field>
        <field name="view_mode">tree,kanban,form,pivot,graph</field>
        <field name="domain">[('payment_direction', '=', 'incoming')]</field>
        <field name="context">{'search_default_approved': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay pagos recibidos
            </p>
            <p>
                Aqui se muestran los pagos que has recibido de tus clientes.
            </p>
        </field>
    </record>

    <record id="action_mercadolibre_payment_outgoing" model="ir.actions.act_window">
        <field name="name">Pagos Realizados</field>
        <field name="res_model">mercadolibre.payment</field>
        <field name="view_mode">tree,kanban,form,pivot,graph</field>
        <field name="domain">[('payment_direction', '=', 'outgoing')]</field>
        <field name="context">{'search_default_approved': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay pagos realizados
            </p>
            <p>
                Aqui se muestran los pagos que has realizado (egresos).
            </p>
        </field>
    </record>

    <record id="action_mercadolibre_payment_in_mediation" model="ir.actions.act_window">
        <field name="name">Pagos en Mediacion</field>
        <field name="res_model">mercadolibre.payment</field>
        <field name="view_mode">tree,kanban,form,pivot,graph</field>
        <field name="domain">[('status', '=', 'in_mediation')]</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay pagos en mediacion
            </p>
            <p>
                Aqui se muestran los pagos que estan en proceso de mediacion/disputa.
                El dinero de estos pagos esta congelado hasta que se resuelva la disputa.
            </p>
        </field>
    </record>
</odoo>
